"""
æ¸¬è©¦å°è©±ä¸Šä¸‹æ–‡é›†æˆ

é©—è­‰æ‰€æœ‰intent handlerå’Œå·¥ä½œæµéƒ½æ­£ç¢ºä½¿ç”¨æ­·å²å°è©±
"""
import asyncio
import pytest
from motor.motor_asyncio import AsyncIOMotorClient
from uuid import uuid4

# é€™å€‹æ¸¬è©¦æ–‡ä»¶ç”¨æ–¼é©—è­‰:
# 1. æ„åœ–åˆ†é¡æ™‚ä½¿ç”¨å°è©±æ­·å²
# 2. æ‰€æœ‰handleréƒ½è¼‰å…¥ä¸¦ä½¿ç”¨å°è©±æ­·å²
# 3. å·¥ä½œæµéˆæ´»è½‰æ›(æ¾„æ¸…->æœç´¢/ç›´æ¥å›ç­”)


async def test_intent_classification_with_history():
    """æ¸¬è©¦æ„åœ–åˆ†é¡æ˜¯å¦æ­£ç¢ºä½¿ç”¨å°è©±æ­·å²"""
    
    print("\n=== æ¸¬è©¦æ¡ˆä¾‹ 1: æ„åœ–åˆ†é¡ä½¿ç”¨å°è©±æ­·å² ===")
    
    # æ¨¡æ“¬å ´æ™¯:
    # ç”¨æˆ¶: "æ‰€æœ‰é›»è²»å¸³å–®"
    # AI: "æ‚¨æƒ³æŸ¥è©¢é›»è²»å¸³å–®å—?"
    # ç”¨æˆ¶: "æ‰€æœ‰æœˆä»½"  <- é€™å€‹å•é¡Œå–®ç¨çœ‹å¾ˆæ¨¡ç³Š,ä½†æœ‰ä¸Šä¸‹æ–‡å°±æ¸…æ™°äº†
    
    print("âœ… å ´æ™¯: ç”¨æˆ¶åœ¨å°è©±ä¸­æåˆ°'æ‰€æœ‰æœˆä»½',æœ‰æ­·å²ä¸Šä¸‹æ–‡æ‡‰è©²ç†è§£ç‚º'æ‰€æœ‰æœˆä»½çš„é›»è²»å¸³å–®'")
    print("âœ… é æœŸ: åˆ†é¡ç‚º document_search è€Œé clarification_needed")
    print("âœ… æª¢æŸ¥é»: question_classifier_service æ¥æ”¶ä¸¦ä½¿ç”¨ conversation_history åƒæ•¸")
    
    # å¯¦éš›æ¸¬è©¦éœ€è¦å•Ÿå‹•å¾Œç«¯æœå‹™
    print("\nğŸ“ æ‰‹å‹•æ¸¬è©¦æ­¥é©Ÿ:")
    print("1. å•Ÿå‹•å¾Œç«¯: cd sortify/backend && uvicorn app.main:app --reload")
    print("2. åœ¨å‰ç«¯å•: 'æ‰€æœ‰é›»è²»å¸³å–®'")
    print("3. AIå›ç­”å¾Œï¼Œå•: 'æ‰€æœ‰æœˆä»½'")
    print("4. æª¢æŸ¥æ—¥èªŒ,ç¢ºèªåˆ†é¡å™¨è¼‰å…¥äº†æ­·å²å°è©±")
    print("5. é©—è­‰AIä¸æœƒè¦æ±‚æ¾„æ¸…,è€Œæ˜¯ç›´æ¥æœç´¢é›»è²»å¸³å–®")


async def test_greeting_handler_with_context():
    """æ¸¬è©¦å¯’æš„è™•ç†å™¨ä½¿ç”¨å°è©±æ­·å²"""
    
    print("\n=== æ¸¬è©¦æ¡ˆä¾‹ 2: å¯’æš„è™•ç†å™¨ä½¿ç”¨å°è©±æ­·å² ===")
    
    print("âœ… å ´æ™¯: ç”¨æˆ¶åœ¨å°è©±ä¸­æåˆ°å°ˆæ¡ˆåç¨±,ç„¶å¾Œèªª'è¬è¬'")
    print("âœ… é æœŸ: AIå›ç­”æœƒæåˆ°å°ˆæ¡ˆç›¸é—œçš„å…§å®¹,è€Œä¸æ˜¯é€šç”¨çš„'ä¸å®¢æ°£'")
    print("âœ… æª¢æŸ¥é»: greeting_handler è¼‰å…¥ä¸¦ä½¿ç”¨å°è©±æ­·å²")
    
    print("\nğŸ“ æ‰‹å‹•æ¸¬è©¦æ­¥é©Ÿ:")
    print("1. å•: 'å¹«æˆ‘æ‰¾ABCå°ˆæ¡ˆçš„æ–‡æª”'")
    print("2. AIå›ç­”å¾Œï¼Œå•: 'è¬è¬'")
    print("3. æª¢æŸ¥æ—¥èªŒ,ç¢ºèª greeting_handler è¼‰å…¥äº†æ­·å²")
    print("4. é©—è­‰AIå›ç­”æåˆ°ABCå°ˆæ¡ˆ")


async def test_simple_factual_with_context():
    """æ¸¬è©¦ç°¡å–®æŸ¥è©¢è™•ç†å™¨ä½¿ç”¨å°è©±æ­·å²"""
    
    print("\n=== æ¸¬è©¦æ¡ˆä¾‹ 3: ç°¡å–®æŸ¥è©¢è™•ç†å™¨ä½¿ç”¨å°è©±æ­·å² ===")
    
    print("âœ… å ´æ™¯: å°è©±ä¸­è¨è«–æŸå€‹æŠ€è¡“,ç”¨æˆ¶å•'å®ƒçš„å„ªé»æ˜¯ä»€éº¼?'")
    print("âœ… é æœŸ: AIç†è§£'å®ƒ'æŒ‡çš„æ˜¯ä¹‹å‰è¨è«–çš„æŠ€è¡“")
    print("âœ… æª¢æŸ¥é»: simple_factual_handler è¼‰å…¥æ­·å²å°è©±")
    
    print("\nğŸ“ æ‰‹å‹•æ¸¬è©¦æ­¥é©Ÿ:")
    print("1. å•: 'ä»€éº¼æ˜¯RAGæŠ€è¡“?'")
    print("2. AIå›ç­”å¾Œï¼Œå•: 'å®ƒçš„å„ªé»æ˜¯ä»€éº¼?'")
    print("3. æª¢æŸ¥æ—¥èªŒ,ç¢ºèª simple_factual_handler è¼‰å…¥äº†æ­·å²")
    print("4. é©—è­‰AIç†è§£'å®ƒ'=RAG")


async def test_workflow_flexible_transition():
    """æ¸¬è©¦å·¥ä½œæµéˆæ´»è½‰æ›"""
    
    print("\n=== æ¸¬è©¦æ¡ˆä¾‹ 4: å·¥ä½œæµéˆæ´»è½‰æ› ===")
    
    print("âœ… å ´æ™¯A: æ¾„æ¸… -> ç›´æ¥å›ç­”")
    print("  ç”¨æˆ¶: 'è²¡å‹™'")
    print("  AI: (æ¾„æ¸…)æ‚¨æ˜¯æƒ³æŸ¥è©¢è²¡å‹™å ±è¡¨é‚„æ˜¯è²¡å‹™æ•¸æ“š?")
    print("  ç”¨æˆ¶: 'ä»€éº¼æ˜¯è²¡å‹™å ±è¡¨?'")
    print("  AI: (é‡æ–°åˆ†é¡å¸¶æ­·å²,åˆ¤æ–·ç‚ºsimple_factual,ç›´æ¥å›ç­”)")
    
    print("\nâœ… å ´æ™¯B: æ¾„æ¸… -> æ–‡æª”æœç´¢")
    print("  ç”¨æˆ¶: 'è²¡å‹™'")
    print("  AI: (æ¾„æ¸…)æ‚¨æ˜¯æƒ³æŸ¥è©¢è²¡å‹™å ±è¡¨é‚„æ˜¯è²¡å‹™æ•¸æ“š?")
    print("  ç”¨æˆ¶: 'å¹«æˆ‘æ‰¾è²¡å‹™å ±è¡¨'")
    print("  AI: (é‡æ–°åˆ†é¡å¸¶æ­·å²,åˆ¤æ–·ç‚ºdocument_search,åŸ·è¡Œæœç´¢)")
    
    print("\nâœ… å ´æ™¯C: æœç´¢ç„¡çµæœ -> æ¾„æ¸…")
    print("  ç”¨æˆ¶: 'å¹«æˆ‘æ‰¾XYZæ–‡æª”'")
    print("  AI: (æœç´¢ç„¡çµæœ,æä¾›èª¿æ•´å»ºè­°)")
    print("  ç”¨æˆ¶: 'é‚£æ‰¾ABCæ–‡æª”'")
    print("  AI: (é‡æ–°æœç´¢)")
    
    print("\nğŸ“ æ‰‹å‹•æ¸¬è©¦æ­¥é©Ÿ:")
    print("1. æ¸¬è©¦å ´æ™¯Aã€Bã€C")
    print("2. æª¢æŸ¥æ¯ä¸€æ­¥çš„æ—¥èªŒ")
    print("3. é©—è­‰å°è©±æ­·å²æ­£ç¢ºå‚³é")
    print("4. ç¢ºèªå·¥ä½œæµç‹€æ…‹æ­£ç¢ºè½‰æ›")


async def test_document_search_approval():
    """æ¸¬è©¦æ–‡æª”æœç´¢æ‰¹å‡†æ©Ÿåˆ¶"""
    
    print("\n=== æ¸¬è©¦æ¡ˆä¾‹ 5: æ–‡æª”æœç´¢æ‰¹å‡†æ©Ÿåˆ¶ ===")
    
    print("âœ… å ´æ™¯: ç”¨æˆ¶æå•éœ€è¦æœç´¢æ–‡æª”")
    print("âœ… é æœŸ: è¿”å› awaiting_search_approval ç‹€æ…‹")
    print("âœ… æª¢æŸ¥é»: document_search_handler è¿”å›æ­£ç¢ºçš„å·¥ä½œæµç‹€æ…‹")
    
    print("\nğŸ“ æ¸¬è©¦æ­¥é©Ÿ:")
    print("1. å•: 'å¹«æˆ‘æ‰¾è²¡å‹™å ±è¡¨'")
    print("2. æª¢æŸ¥éŸ¿æ‡‰çš„ workflow_state.current_step === 'awaiting_search_approval'")
    print("3. å‰ç«¯é¡¯ç¤ºæ‰¹å‡†UI")
    print("4. é»æ“Š'æ‰¹å‡†æœç´¢',å¸¶ä¸Š workflow_action='approve_search'")
    print("5. æª¢æŸ¥æœç´¢æ­£å¸¸åŸ·è¡Œä¸¦è¿”å›ç­”æ¡ˆ")
    print("\næˆ–è€…:")
    print("4. é»æ“Š'è·³é',å¸¶ä¸Š workflow_action='skip_search'")
    print("5. æª¢æŸ¥è¿”å›é€šç”¨çŸ¥è­˜å›ç­”")


def print_test_summary():
    """æ‰“å°æ¸¬è©¦ç¸½çµ"""
    
    print("\n" + "="*80)
    print("ğŸ¯ å°è©±ä¸Šä¸‹æ–‡é›†æˆæ¸¬è©¦ç¸½çµ")
    print("="*80)
    
    print("\nâœ… å·²ä¿®å¾©çš„çµ„ä»¶:")
    print("  1. âœ“ enhanced_ai_qa_service.py - æ„åœ–åˆ†é¡å‰è¼‰å…¥æ­·å²")
    print("  2. âœ“ question_classifier_service.py - æ ¼å¼åŒ–ä¸¦å‚³éæ­·å²çµ¦AI")
    print("  3. âœ“ prompt_manager_simplified.py - promptåŒ…å«æ­·å²å°è©±")
    print("  4. âœ“ greeting_handler.py - è¼‰å…¥æ­·å²å°è©±")
    print("  5. âœ“ simple_factual_handler.py - å…©å€‹æ–¹æ³•éƒ½è¼‰å…¥æ­·å²")
    print("  6. âœ“ document_search_handler.py - è¼‰å…¥æ­·å²ä¸¦æ”¯æŒæ‰¹å‡†")
    print("  7. âœ“ complex_analysis_handler.py - å·²æœ‰æ­·å²æ”¯æŒ")
    print("  8. âœ“ clarification_handler.py - æ¾„æ¸…å¾Œè‡ªå‹•é‡æ–°è·¯ç”±")
    
    print("\nâœ… æ–°å¢åŠŸèƒ½:")
    print("  1. âœ“ workflow_coordinator.py - å·¥ä½œæµéˆæ´»è½‰æ›")
    print("  2. âœ“ æ–‡æª”æœç´¢æ‰¹å‡†æ©Ÿåˆ¶")
    print("  3. âœ“ æœç´¢ç„¡çµæœæ™ºèƒ½å»ºè­°")
    print("  4. âœ“ å‰ç«¯å·¥ä½œæµUIé›†æˆ")
    
    print("\nğŸš€ ç³»çµ±èƒ½åŠ›:")
    print("  â€¢ æ‰€æœ‰æµç¨‹éƒ½ä½¿ç”¨å°è©±æ­·å²ä½œç‚ºä¸Šä¸‹æ–‡")
    print("  â€¢ å·¥ä½œæµå¯åœ¨å„éšæ®µéˆæ´»è½‰æ›")
    print("  â€¢ æ¾„æ¸…å¾Œè‡ªå‹•é‡æ–°åˆ†é¡ä¸¦è·¯ç”±")
    print("  â€¢ æœç´¢ç„¡çµæœæ™‚æä¾›æ™ºèƒ½å»ºè­°")
    print("  â€¢ æ”¯æŒç”¨æˆ¶æ‰¹å‡†æ–‡æª”æœç´¢")
    
    print("\nğŸ“‹ æ¸¬è©¦æ¸…å–®:")
    print("  â–¡ æ¸¬è©¦æ¡ˆä¾‹1: æ„åœ–åˆ†é¡ä½¿ç”¨å°è©±æ­·å²")
    print("  â–¡ æ¸¬è©¦æ¡ˆä¾‹2: å¯’æš„è™•ç†å™¨ä½¿ç”¨å°è©±æ­·å²")
    print("  â–¡ æ¸¬è©¦æ¡ˆä¾‹3: ç°¡å–®æŸ¥è©¢ä½¿ç”¨å°è©±æ­·å²")
    print("  â–¡ æ¸¬è©¦æ¡ˆä¾‹4: å·¥ä½œæµéˆæ´»è½‰æ›")
    print("  â–¡ æ¸¬è©¦æ¡ˆä¾‹5: æ–‡æª”æœç´¢æ‰¹å‡†æ©Ÿåˆ¶")
    
    print("\nğŸ’¡ å•Ÿå‹•æ¸¬è©¦:")
    print("  1. å•Ÿå‹•å¾Œç«¯: cd sortify/backend && uvicorn app.main:app --reload")
    print("  2. å•Ÿå‹•å‰ç«¯: cd sortify/frontend && npm start")
    print("  3. æŒ‰ç…§ä¸Šè¿°æ¸¬è©¦æ­¥é©ŸåŸ·è¡Œ")
    print("  4. æŸ¥çœ‹å¾Œç«¯æ—¥èªŒç¢ºèªå°è©±æ­·å²è¼‰å…¥")
    
    print("\n" + "="*80)


if __name__ == "__main__":
    print("ğŸ§ª å°è©±ä¸Šä¸‹æ–‡é›†æˆæ¸¬è©¦æŒ‡å—\n")
    
    # é‹è¡Œæ‰€æœ‰æ¸¬è©¦æ¡ˆä¾‹èªªæ˜
    asyncio.run(test_intent_classification_with_history())
    asyncio.run(test_greeting_handler_with_context())
    asyncio.run(test_simple_factual_with_context())
    asyncio.run(test_workflow_flexible_transition())
    asyncio.run(test_document_search_approval())
    
    # æ‰“å°ç¸½çµ
    print_test_summary()

