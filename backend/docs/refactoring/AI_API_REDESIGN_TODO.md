# AI API 重新設計待辦

**創建時間**: 2024-11-16  
**狀態**: ⏸️ 暫停日誌重構，等待重新設計

---

## 📋 需要重新設計的 AI API

### 1. **unified_ai.py** - 統一 AI 服務端點

**端點數量**: 10 個  
**代碼大小**: 29KB  
**手動日誌**: 26 處  
**優先級**: 🔴 最高

**端點列表**:
```
POST /analyze-text          - 文本分析
POST /query-rewrite         - 查詢重寫
POST /qa                    - 問答
POST /extract-entities      - 實體提取
POST /classify              - 文本分類
POST /summarize            - 摘要生成
POST /explain               - 解釋
POST /detect-intent         - 意圖檢測
POST /evaluate-document     - 文檔評估
POST /generate-response     - 生成響應
```

**問題**:
- 端點過多，職責不清晰
- 與 enhanced_ai_qa_service 耦合
- 需要重新設計 API 結構

---

### 2. **qa_stream.py** - 流式問答端點

**端點數量**: 1 個  
**代碼大小**: 38KB  
**手動日誌**: ?  
**優先級**: 🔴 高

**端點列表**:
```
POST /stream               - 流式問答
```

**問題**:
- 極其複雜的流式處理
- 需要專門的測試策略
- 與多個服務緊密耦合

---

### 3. 其他 AI 相關端點

#### **clustering.py**
- **端點**: 9 個
- **日誌**: 20 處
- **問題**: 聚類邏輯複雜，需要評估重構價值

#### **suggested_questions.py**
- **端點**: 7 個
- **問題**: AI 生成建議問題

#### **qa_analytics.py**
- **端點**: 3 個
- **問題**: 分析邏輯

---

## 🎯 重新設計建議

### Option A: 合併簡化（推薦）

**目標**: 將多個 AI 端點合併為統一接口

```python
# 新設計：統一的 AI 處理端點
POST /ai/process
{
    "task_type": "qa" | "summarize" | "classify" | ...,
    "input": "...",
    "options": {...}
}
```

**優勢**:
- 統一的錯誤處理
- 統一的日誌記錄
- 減少端點數量
- 更易測試

---

### Option B: 按功能分組

**目標**: 將端點按功能域分組

```
/ai/text-analysis/     - 文本分析相關
/ai/qa/               - 問答相關
/ai/document/         - 文檔處理相關
```

**優勢**:
- 清晰的功能邊界
- 易於權限控制
- 漸進式重構

---

## 📝 待辦任務

### Phase 1: 分析與設計
- [ ] 分析所有 AI 端點的使用情況
- [ ] 識別重複的邏輯
- [ ] 設計新的 API 結構
- [ ] 編寫設計文檔

### Phase 2: 測試準備
- [ ] 為現有 AI 端點編寫集成測試
- [ ] 定義測試策略（特別是流式端點）
- [ ] 準備測試數據

### Phase 3: 重構實施
- [ ] 實施新的 API 設計
- [ ] 遷移現有端點
- [ ] 應用 @log_api_operation 裝飾器
- [ ] 移除重複日誌

### Phase 4: 驗證與部署
- [ ] 運行完整測試套件
- [ ] 性能測試
- [ ] 更新 API 文檔
- [ ] 部署

---

## ⚠️ 當前狀態

**決定**: 暫不對 AI API 進行日誌重構

**原因**:
1. AI 端點需要重新設計
2. 避免在重新設計前做無效重構
3. 先完成非 AI API 的重構

**下一步**: 
- ✅ 完成非 AI API 重構（users, auth, system）
- ⏸️ 暫停，等待 AI API 重新設計決策
- 📋 收集團隊反饋和需求

---

## 📊 影響評估

### 暫不重構的影響
- ✅ 不影響核心功能
- ✅ 不影響系統穩定性
- ⚠️ AI 端點日誌仍然手動管理
- ⚠️ 代碼重複仍然存在

### 重新設計後的預期收益
- 📉 代碼減少 30-40%
- 📈 可測試性提升 50%+
- 🚀 開發效率提升
- 🎯 更清晰的 API 結構

---

**備注**: 此文檔會隨著 AI API 重新設計的進展更新
